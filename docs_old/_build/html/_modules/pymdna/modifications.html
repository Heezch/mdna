<!DOCTYPE html>

<html lang="en" data-content_root="../../">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>pymdna.modifications &#8212; mdna 1.0.0 documentation</title>
    <link rel="stylesheet" type="text/css" href="../../_static/pygments.css?v=d1102ebc" />
    <link rel="stylesheet" type="text/css" href="../../_static/alabaster.css?v=12dfc556" />
    <script src="../../_static/documentation_options.js?v=8d563738"></script>
    <script src="../../_static/doctools.js?v=9a2dae69"></script>
    <script src="../../_static/sphinx_highlight.js?v=dc90522c"></script>
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" />
   
  <link rel="stylesheet" href="../../_static/custom.css" type="text/css" />
  

  
  

  </head><body>
  

    <div class="document">
      <div class="documentwrapper">
        <div class="bodywrapper">
          

          <div class="body" role="main">
            
  <h1>Source code for pymdna.modifications</h1><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">.utils</span> <span class="kn">import</span> <span class="n">get_base_pair_dict</span><span class="p">,</span> <span class="n">RigidBody</span><span class="p">,</span> <span class="n">get_data_file_path</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">.geometry</span> <span class="kn">import</span> <span class="n">ReferenceBase</span>
<span class="kn">import</span> <span class="nn">mdtraj</span> <span class="k">as</span> <span class="nn">md</span>
<span class="kn">import</span> <span class="nn">copy</span>
<span class="kn">from</span> <span class="nn">mdtraj.core</span> <span class="kn">import</span> <span class="n">element</span> <span class="k">as</span> <span class="n">elem</span>



<div class="viewcode-block" id="Methylate">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Methylate">[docs]</a>
<span class="k">class</span> <span class="nc">Methylate</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Class to add methyl groups to the DNA structure</span>
<span class="sd">    Methylate DNA currently only does C and G methylation (no A or T) and G at the O6 oxygen and C at the C5 carbon</span>
<span class="sd">    In principle we could add an extra requirement for C to only methylate when it is in a CpG context</span>

<span class="sd">    Example:</span>
<span class="sd">    # This methylates the first base in the pdb file </span>
<span class="sd">    methylator = mdna.Methylate(pdb, methylations=[0])</span>
<span class="sd">    methylated_traj = methylator.get_traj()</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">methylations</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">CpG</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">leading_strand</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">CpG</span> <span class="ow">and</span> <span class="n">leading_strand</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Methylate all C in CpG context, superseeds methylations list.&#39;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baselist</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_CpGs</span><span class="p">(</span><span class="n">leading_strand</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Methtylating:&#39;</span><span class="p">,</span><span class="bp">self</span><span class="o">.</span><span class="n">baselist</span><span class="p">)</span>
        <span class="k">elif</span> <span class="n">CpG</span> <span class="ow">and</span> <span class="n">leading_strand</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
             <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Please provide chainid of `leading_strand` as argument.&quot;</span><span class="p">)</span>
        <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">methylations</span><span class="p">)</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">baselist</span> <span class="o">=</span> <span class="n">methylations</span> <span class="c1"># List of resids that need to be methylated (so far only C and G)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Please provide either a list of resids to methylate or set CpG to True with chainid of `leading_strand` as argument.&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_methylation</span><span class="p">()</span>
    
<div class="viewcode-block" id="Methylate.apply_methylation">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Methylate.apply_methylation">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_methylation</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># For each residue that needs to be mutated</span>
        <span class="k">for</span> <span class="n">resid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">baselist</span><span class="p">:</span>
            
            <span class="c1"># Current residue</span>
            <span class="n">residue</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">residue</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span>
            
            <span class="c1"># Get residue code</span>
            <span class="n">code</span> <span class="o">=</span> <span class="n">residue</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="c1"># Assume DC DG DT DA </span>

            <span class="c1"># Get dock and ref atom to add carbon methyl</span>
            <span class="n">a</span><span class="p">,</span> <span class="n">b</span>  <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_atoms</span><span class="p">(</span><span class="n">residue</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span>

            <span class="c1"># Filter such that only C and G can get methylated</span>
            <span class="k">if</span> <span class="n">a</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">b</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">add_methyl</span><span class="p">(</span><span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">code</span><span class="p">)</span> <span class="c1"># Add the methyl group to the residue </span>
                <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">residue</span><span class="p">(</span><span class="n">resid</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;D</span><span class="si">{</span><span class="n">code</span><span class="si">}</span><span class="s1">M&#39;</span> <span class="c1"># Update the residue name to reflect the mutation</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">continue</span></div>



<div class="viewcode-block" id="Methylate.find_CpGs">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Methylate.find_CpGs">[docs]</a>
    <span class="k">def</span> <span class="nf">find_CpGs</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span><span class="n">leading_strand</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="n">sequence</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="o">.</span><span class="n">join</span><span class="p">([</span><span class="n">res</span><span class="o">.</span><span class="n">name</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="k">for</span> <span class="n">res</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">chain</span><span class="p">(</span><span class="n">leading_strand</span><span class="p">)</span><span class="o">.</span><span class="n">_residues</span><span class="p">])</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">i</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sequence</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span> <span class="k">if</span> <span class="n">sequence</span><span class="p">[</span><span class="n">i</span><span class="p">:</span><span class="n">i</span><span class="o">+</span><span class="mi">2</span><span class="p">]</span> <span class="o">==</span> <span class="s1">&#39;CG&#39;</span><span class="p">]</span></div>


<div class="viewcode-block" id="Methylate.get_atoms">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Methylate.get_atoms">[docs]</a>
    <span class="k">def</span> <span class="nf">get_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>
        <span class="c1"># Get the atoms to add the methyl group to</span>
        <span class="n">atom_a</span><span class="p">,</span> <span class="n">atom_b</span>  <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span>
        <span class="k">for</span> <span class="n">at</span> <span class="ow">in</span> <span class="n">residue</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">str</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C5&#39;</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="c1"># The anchor atom for the methyl group (C5)</span>
                <span class="n">atom_a</span> <span class="o">=</span> <span class="n">at</span>
            <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;C2&#39;</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span> <span class="c1"># Reference atom to create vector</span>
                <span class="n">atom_b</span> <span class="o">=</span> <span class="n">at</span>
            <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;O6&#39;</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="c1"># The anchor atom for the methyl group (C6)</span>
                <span class="n">atom_a</span> <span class="o">=</span> <span class="n">at</span>
            <span class="k">elif</span> <span class="nb">str</span><span class="p">(</span><span class="n">at</span><span class="o">.</span><span class="n">name</span><span class="p">)</span> <span class="o">==</span> <span class="s1">&#39;N2&#39;</span> <span class="ow">and</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span> <span class="c1"># Reference atom to create vector </span>
                <span class="n">atom_b</span> <span class="o">=</span> <span class="n">at</span>

        <span class="k">return</span> <span class="n">atom_a</span><span class="p">,</span> <span class="n">atom_b</span></div>


<div class="viewcode-block" id="Methylate.add_methyl">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Methylate.add_methyl">[docs]</a>
    <span class="k">def</span> <span class="nf">add_methyl</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">a</span><span class="p">,</span> <span class="n">b</span><span class="p">,</span> <span class="n">residue</span><span class="p">,</span> <span class="n">code</span><span class="p">):</span>

        <span class="c1"># Get the index of the atom to insert the new atom after</span>
        <span class="n">index</span> <span class="o">=</span> <span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="o">+</span><span class="mi">1</span>

        <span class="c1"># Calculate new position with displacement of 0.138 nm in direction of a-b</span>
        <span class="n">vec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">-</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="n">b</span><span class="o">.</span><span class="n">index</span><span class="p">]</span>
        <span class="n">vec</span> <span class="o">/=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">vec</span><span class="p">)</span>
        <span class="n">new_pos</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="n">a</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">+</span> <span class="mf">0.138</span> <span class="o">*</span> <span class="n">vec</span>
        
        <span class="c1"># split xyz old in two at where the new atom will be inserted</span>
        <span class="n">xyz1</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,:</span><span class="n">index</span><span class="p">,:]</span>
        <span class="n">xyz2</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="n">index</span><span class="p">:,:]</span>

        <span class="c1"># Determine name</span>
        <span class="k">if</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;C&#39;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;C5M&#39;</span> <span class="c1"># Not cetain about this name</span>
        <span class="k">elif</span> <span class="n">code</span> <span class="o">==</span> <span class="s1">&#39;G&#39;</span><span class="p">:</span>
            <span class="n">name</span> <span class="o">=</span> <span class="s1">&#39;C6M&#39;</span> <span class="c1"># Nor this one hahaha</span>

        <span class="c1"># Insert atom </span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">insert_atom</span><span class="p">(</span><span class="n">name</span><span class="o">=</span><span class="n">name</span><span class="p">,</span> <span class="n">element</span><span class="o">=</span><span class="n">elem</span><span class="o">.</span><span class="n">carbon</span><span class="p">,</span> <span class="n">residue</span><span class="o">=</span><span class="n">residue</span><span class="p">,</span> <span class="n">index</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">rindex</span><span class="o">=</span><span class="n">index</span><span class="p">,</span> <span class="n">serial</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
        
        <span class="c1"># stack the two xyz arrays together with the new_pos in between</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">xyz1</span><span class="p">,</span> <span class="n">new_pos</span><span class="p">[:,</span><span class="kc">None</span><span class="p">,:],</span> <span class="n">xyz2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>


<div class="viewcode-block" id="Methylate.get_traj">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Methylate.get_traj">[docs]</a>
    <span class="k">def</span> <span class="nf">get_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span></div>
</div>

    

<div class="viewcode-block" id="Hoogsteen">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Hoogsteen">[docs]</a>
<span class="k">class</span> <span class="nc">Hoogsteen</span><span class="p">:</span>
    <span class="c1"># should still update for all the other bases (non-canonical)</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">fliplist</span><span class="p">,</span> <span class="n">deg</span><span class="o">=</span><span class="mi">180</span><span class="p">,</span><span class="n">verbose</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">verbose</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fliplist</span> <span class="o">=</span> <span class="n">fliplist</span> <span class="c1"># List of resids that need to be flipped</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">theta</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">deg</span><span class="p">)</span> <span class="c1"># Set the rotation angle to 180 degrees</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">apply_flips</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Flipped residues </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">fliplist</span><span class="si">}</span><span class="s2"> by </span><span class="si">{</span><span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="si">}</span><span class="s2"> radians&quot;</span><span class="p">)</span>

<div class="viewcode-block" id="Hoogsteen.select_atom_by_name">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Hoogsteen.select_atom_by_name">[docs]</a>
    <span class="k">def</span> <span class="nf">select_atom_by_name</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name</span><span class="p">):</span>
        <span class="c1"># Select an atom by name returns shape (n_frames, 1, [x,y,z])</span>
        <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,[</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;name </span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)[</span><span class="mi">0</span><span class="p">]],:],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>



<div class="viewcode-block" id="Hoogsteen.get_base_type">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Hoogsteen.get_base_type">[docs]</a>
    <span class="k">def</span> <span class="nf">get_base_type</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">indices</span><span class="p">):</span>
        <span class="c1"># Identify whether base is a purine or pyrimidine based on presence of N1/N9</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">atom_slice</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">res</span><span class="o">.</span><span class="n">topology</span><span class="o">.</span><span class="n">atoms</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;N1&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;pyrimidine&quot;</span>
            <span class="k">elif</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="s2">&quot;N9&quot;</span><span class="p">:</span>
                <span class="k">return</span> <span class="s2">&quot;purine&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Cannot determine the base type from the PDB file.&quot;</span><span class="p">)</span></div>


<div class="viewcode-block" id="Hoogsteen.get_coordinates">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Hoogsteen.get_coordinates">[docs]</a>
    <span class="k">def</span> <span class="nf">get_coordinates</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_type</span><span class="p">,</span> <span class="n">resid</span><span class="p">):</span>
        <span class="c1"># Get the coordinates of key atoms based on the base type</span>
        <span class="n">C1_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_atom_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;&quot;C1</span><span class="se">\&#39;</span><span class="s1">&quot; and resid </span><span class="si">{</span><span class="n">resid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">base_type</span> <span class="o">==</span> <span class="s2">&quot;pyrimidine&quot;</span><span class="p">:</span>
            <span class="n">N_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_atom_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N1 and resid </span><span class="si">{</span><span class="n">resid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1"># C_coords = self._select_atom_by_name(&quot;C2&quot;)</span>
        <span class="k">elif</span> <span class="n">base_type</span> <span class="o">==</span> <span class="s2">&quot;purine&quot;</span><span class="p">:</span>
            <span class="n">N_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">select_atom_by_name</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;N9 and resid </span><span class="si">{</span><span class="n">resid</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="c1">#C_coords = self.select_atom_by_name(&quot;C4&quot;) # changed this for HS testing from C4 to C5</span>
        <span class="k">return</span> <span class="n">C1_coords</span><span class="p">,</span> <span class="n">N_coords</span> <span class="c1">#, C_coords</span></div>


<div class="viewcode-block" id="Hoogsteen.get_base_indices">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Hoogsteen.get_base_indices">[docs]</a>
    <span class="k">def</span> <span class="nf">get_base_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">resid</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="c1"># # Define the atoms that belong to the nucleotide</span>
        <span class="c1"># base_atoms = { &#39;C2&#39;,&#39;C4&#39;,&#39;C5&#39;,&#39;C6&#39;,&#39;C7&#39;,&#39;C8&#39;,&#39;C5M&#39;,</span>
        <span class="c1">#                &#39;N1&#39;,&#39;N2&#39;,&#39;N3&#39;,&#39;N4&#39;,&#39;N6&#39;,&#39;N7&#39;,&#39;N9&#39;,</span>
        <span class="c1">#                &#39;O2&#39;,&#39;O4&#39;,&#39;O6&#39;,</span>
        <span class="c1">#                &#39;H1&#39;,&#39;H2&#39;,&#39;H3&#39;,&#39;H5&#39;,&#39;H6&#39;,&#39;H8&#39;,</span>
        <span class="c1">#                &#39;H21&#39;,&#39;H22&#39;,&#39;H41&#39;,&#39;H42&#39;,&#39;H61&#39;,&#39;H62&#39;,&#39;H71&#39;,&#39;H72&#39;,&#39;H73&#39;}</span>
            
            <span class="c1"># &#39;N9&#39;, &#39;N7&#39;, &#39;C8&#39;, &#39;C5&#39;, &#39;C4&#39;, &#39;N3&#39;, &#39;C2&#39;, &#39;N1&#39;, </span>
            <span class="c1">#         &#39;C6&#39;, &#39;C7&#39;,&#39;O6&#39;, &#39;N2&#39;, &#39;N6&#39;, &#39;O2&#39;, &#39;N4&#39;, &#39;O4&#39;, &#39;C5M&#39;,</span>
            <span class="c1">#         &#39;H1&#39;,&#39;H2&#39;,&#39;H21&#39;,&#39;H22&#39;,&#39;H3&#39;,&#39;H41&#39;,&#39;H42&#39;,&#39;H5&#39;,&#39;H6&#39;,&#39;H61&#39;,&#39;H62&#39;,&#39;H71&#39;,&#39;H72&#39;,&#39;H73&#39;,&#39;H8&#39;}</span>
        <span class="c1"># Select atoms that belong to the specified residue</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resid </span><span class="si">{</span><span class="n">resid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Save the initial index of the residue</span>
    
        <span class="c1"># Create a subtrajectory containing only the specified residue</span>
        <span class="n">subtraj</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">atom_slice</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>

        <span class="c1"># Select the atoms that belong to the nucleotide</span>
        <span class="c1">#sub_indices = subtraj.top.select(f&#39;name {&quot; &quot;.join(base_atoms)}&#39;)</span>
        <span class="n">sub_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">subtraj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="s1">&#39;P&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="c1"># Return the indices of the atoms that belong to the nucleotide</span>
        <span class="k">return</span> <span class="n">sub_indices</span> <span class="o">+</span> <span class="n">offset</span></div>

    
<div class="viewcode-block" id="Hoogsteen.apply_flips">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Hoogsteen.apply_flips">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_flips</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="c1"># For each residue that needs to be mutated</span>
        <span class="k">for</span> <span class="n">resid</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">fliplist</span><span class="p">:</span>
            
            <span class="c1"># Get the indices of the atoms that need to be transformed</span>
            <span class="n">nucleobase_selection</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_indices</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">,</span> <span class="n">resid</span><span class="o">=</span><span class="n">resid</span><span class="p">)</span>
            <span class="n">base_type</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_type</span><span class="p">(</span><span class="n">nucleobase_selection</span><span class="p">)</span>

            <span class="c1"># Get the coordinates of the atoms involved in the rotation</span>
            <span class="c1"># c1_prime_coords = self.select_atom_by_name(self.traj, f&#39;&quot;C1\&#39;&quot; and resid {resid}&#39;)</span>
            <span class="c1"># n9_coords = self.select_atom_by_name(self.traj, f&quot;N9 and resid {resid}&quot;)</span>
            
            <span class="n">c1_prime_coords</span><span class="p">,</span> <span class="n">n_coords</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_coordinates</span><span class="p">(</span><span class="n">base_type</span><span class="p">,</span> <span class="n">resid</span><span class="p">)</span>
            <span class="c1"># Calculate the Euler vector for the 180-degree rotation around the specified axis and normalize the axis vector</span>
            <span class="n">rotation_axis</span> <span class="o">=</span> <span class="n">c1_prime_coords</span> <span class="o">-</span> <span class="n">n_coords</span>
            <span class="n">rotation_axis</span> <span class="o">=</span> <span class="n">rotation_axis</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">norm</span><span class="p">(</span><span class="n">rotation_axis</span><span class="p">)</span>

            <span class="c1"># Update the xyz of the nucleobase in base_A.xyz using the rotation</span>
            <span class="n">relative_positions</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span> <span class="n">nucleobase_selection</span><span class="p">,</span> <span class="p">:]</span> <span class="o">-</span> <span class="n">n_coords</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># Apply the rotation to each atom&#39;s relative position</span>
            <span class="n">rotated_positions</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">RigidBody</span><span class="o">.</span><span class="n">rotate_vector</span><span class="p">(</span><span class="n">v</span><span class="p">,</span> <span class="n">rotation_axis</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="bp">self</span><span class="o">.</span><span class="n">theta</span><span class="p">)</span> <span class="k">for</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">relative_positions</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

            <span class="c1"># Translate the rotated positions back to the original coordinate system</span>
            <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">rotated_positions</span> <span class="o">+</span> <span class="n">n_coords</span><span class="p">[:,</span> <span class="kc">None</span><span class="p">,</span> <span class="p">:]</span>

            <span class="c1"># Update the coordinates in the trajectory</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span> <span class="n">nucleobase_selection</span><span class="p">,</span> <span class="p">:]</span> <span class="o">=</span> <span class="n">new_xyz</span></div>


<div class="viewcode-block" id="Hoogsteen.get_traj">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Hoogsteen.get_traj">[docs]</a>
    <span class="k">def</span> <span class="nf">get_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">traj</span></div>
</div>


<div class="viewcode-block" id="Mutate">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Mutate">[docs]</a>
<span class="k">class</span> <span class="nc">Mutate</span><span class="p">:</span>

    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">mutations</span><span class="p">,</span> <span class="n">complementary</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
    
        <span class="bp">self</span><span class="o">.</span><span class="n">traj</span> <span class="o">=</span> <span class="n">traj</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">complementary</span> <span class="o">=</span> <span class="n">complementary</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span> <span class="o">=</span> <span class="n">mutations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">current_resid</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutate</span><span class="p">()</span>

<div class="viewcode-block" id="Mutate.mutate">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Mutate.mutate">[docs]</a>
    <span class="k">def</span> <span class="nf">mutate</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>

        <span class="c1"># Define the base pair map and the complementary mutant map</span>
        <span class="c1">#base_pair_map = {&#39;A&#39;: &#39;T&#39;, &#39;T&#39;: &#39;A&#39;, &#39;C&#39;: &#39;G&#39;, &#39;G&#39;: &#39;C&#39;,&#39;P&#39;:&#39;T&#39;,&#39;D&#39;:&#39;C&#39;}</span>
        <span class="n">base_pair_map</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;A&#39;</span><span class="p">:</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;T&#39;</span><span class="p">:</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;G&#39;</span><span class="p">:</span><span class="s1">&#39;C&#39;</span><span class="p">,</span><span class="s1">&#39;C&#39;</span><span class="p">:</span><span class="s1">&#39;G&#39;</span><span class="p">,</span><span class="s1">&#39;U&#39;</span><span class="p">:</span><span class="s1">&#39;A&#39;</span><span class="p">,</span><span class="s1">&#39;D&#39;</span><span class="p">:</span><span class="s1">&#39;G&#39;</span><span class="p">,</span><span class="s1">&#39;E&#39;</span><span class="p">:</span><span class="s1">&#39;T&#39;</span><span class="p">,</span><span class="s1">&#39;L&#39;</span><span class="p">:</span><span class="s1">&#39;M&#39;</span><span class="p">,</span><span class="s1">&#39;M&#39;</span><span class="p">:</span><span class="s1">&#39;L&#39;</span><span class="p">,</span><span class="s1">&#39;B&#39;</span><span class="p">:</span><span class="s1">&#39;S&#39;</span><span class="p">,</span><span class="s1">&#39;S&#39;</span><span class="p">:</span><span class="s1">&#39;B&#39;</span><span class="p">,</span><span class="s1">&#39;Z&#39;</span><span class="p">:</span><span class="s1">&#39;P&#39;</span><span class="p">,</span><span class="s1">&#39;P&#39;</span><span class="p">:</span><span class="s1">&#39;Z&#39;</span><span class="p">}</span>
        
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">complementary</span><span class="p">:</span>
            <span class="c1"># Update dict with the complementary mutations</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">make_complementary_mutations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span><span class="p">,</span> <span class="n">base_pair_map</span><span class="p">)</span>

        <span class="c1"># Apply the mutations</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">mutant_traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">apply_mutations</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">traj</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutations</span><span class="p">,</span> <span class="n">base_pair_map</span><span class="p">)</span></div>


<div class="viewcode-block" id="Mutate.get_base_indices">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Mutate.get_base_indices">[docs]</a>
    <span class="k">def</span> <span class="nf">get_base_indices</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">base_traj</span><span class="p">,</span> <span class="n">resid</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>

        <span class="c1"># Define the atoms that belong to the nucleotide</span>
        <span class="c1">#     base_atoms = { &#39;C2&#39;,&#39;C4&#39;,&#39;C5&#39;,&#39;C6&#39;,&#39;C7&#39;,&#39;C8&#39;,&#39;C5M&#39;,</span>
        <span class="c1">#                    &#39;N1&#39;,&#39;N2&#39;,&#39;N3&#39;,&#39;N4&#39;,&#39;N6&#39;,&#39;N7&#39;,&#39;N9&#39;,</span>
        <span class="c1">#                    &#39;O2&#39;,&#39;O4&#39;,&#39;O6&#39;,</span>
        <span class="c1">#                    &#39;H1&#39;,&#39;H2&#39;,&#39;H3&#39;,&#39;H5&#39;,&#39;H6&#39;,&#39;H8&#39;,</span>
        <span class="c1">#                    &#39;H21&#39;,&#39;H22&#39;,&#39;H41&#39;,&#39;H42&#39;,&#39;H61&#39;,&#39;H62&#39;,&#39;H71&#39;,&#39;H72&#39;,&#39;H73&#39;}</span>

        <span class="c1">#    # noncanon_base_atoms = {&#39;N9&#39;,&#39;C8&#39;,  &#39;H8&#39;,  &#39;N7&#39;,  &#39;C5&#39;, &#39;C6&#39;, &#39;N7&#39;, &#39;N61&#39;, &#39;N62&#39;, &#39;N1&#39;, &#39;C2&#39;, &#39;H2&#39;, &#39;N3&#39;,&#39;C4&#39;,&#39;N1&#39; ,&#39;C2&#39;, &#39;O2&#39;, &#39;N3&#39;, &#39;C4&#39;, &#39;C6&#39;, &#39;C14&#39;, &#39;C13&#39;, &#39;N5&#39;, &#39;C11&#39;, &#39;S12&#39;, &#39;C7&#39;, &#39;C8&#39;, &#39;C9&#39;, &#39;C10&#39;} # TC1</span>
            
        <span class="n">base_atoms</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span><span class="s1">&#39;C4&#39;</span><span class="p">,</span><span class="s1">&#39;C5&#39;</span><span class="p">,</span><span class="s1">&#39;C6&#39;</span><span class="p">,</span><span class="s1">&#39;C7&#39;</span><span class="p">,</span><span class="s1">&#39;C8&#39;</span><span class="p">,</span><span class="s1">&#39;C5M&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;N1&#39;</span><span class="p">,</span><span class="s1">&#39;N2&#39;</span><span class="p">,</span><span class="s1">&#39;N3&#39;</span><span class="p">,</span><span class="s1">&#39;N4&#39;</span><span class="p">,</span><span class="s1">&#39;N6&#39;</span><span class="p">,</span><span class="s1">&#39;N7&#39;</span><span class="p">,</span><span class="s1">&#39;N9&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;O2&#39;</span><span class="p">,</span><span class="s1">&#39;O4&#39;</span><span class="p">,</span><span class="s1">&#39;O6&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;H1&#39;</span><span class="p">,</span><span class="s1">&#39;H2&#39;</span><span class="p">,</span><span class="s1">&#39;H3&#39;</span><span class="p">,</span><span class="s1">&#39;H5&#39;</span><span class="p">,</span><span class="s1">&#39;H6&#39;</span><span class="p">,</span><span class="s1">&#39;H8&#39;</span><span class="p">,</span>
                       <span class="s1">&#39;H21&#39;</span><span class="p">,</span><span class="s1">&#39;H22&#39;</span><span class="p">,</span><span class="s1">&#39;H41&#39;</span><span class="p">,</span><span class="s1">&#39;H42&#39;</span><span class="p">,</span><span class="s1">&#39;H61&#39;</span><span class="p">,</span><span class="s1">&#39;H62&#39;</span><span class="p">,</span><span class="s1">&#39;H71&#39;</span><span class="p">,</span><span class="s1">&#39;H72&#39;</span><span class="p">,</span><span class="s1">&#39;H73&#39;</span><span class="p">,</span><span class="s1">&#39;N9&#39;</span><span class="p">,</span><span class="s1">&#39;C8&#39;</span><span class="p">,</span><span class="s1">&#39;H8&#39;</span><span class="p">,</span>  
                       <span class="s1">&#39;N7&#39;</span><span class="p">,</span><span class="s1">&#39;C5&#39;</span><span class="p">,</span><span class="s1">&#39;C6&#39;</span><span class="p">,</span> <span class="s1">&#39;N7&#39;</span><span class="p">,</span> <span class="s1">&#39;N61&#39;</span><span class="p">,</span> <span class="s1">&#39;N62&#39;</span><span class="p">,</span><span class="s1">&#39;N1&#39;</span><span class="p">,</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span><span class="s1">&#39;H2&#39;</span><span class="p">,</span><span class="s1">&#39;N3&#39;</span><span class="p">,</span><span class="s1">&#39;C4&#39;</span><span class="p">,</span><span class="s1">&#39;N1&#39;</span><span class="p">,</span><span class="s1">&#39;C2&#39;</span><span class="p">,</span> 
                       <span class="s1">&#39;O2&#39;</span><span class="p">,</span><span class="s1">&#39;N3&#39;</span><span class="p">,</span><span class="s1">&#39;C4&#39;</span><span class="p">,</span><span class="s1">&#39;C6&#39;</span><span class="p">,</span><span class="s1">&#39;C14&#39;</span><span class="p">,</span><span class="s1">&#39;C13&#39;</span><span class="p">,</span><span class="s1">&#39;N5&#39;</span><span class="p">,</span><span class="s1">&#39;C11&#39;</span><span class="p">,</span><span class="s1">&#39;S12&#39;</span><span class="p">,</span><span class="s1">&#39;C7&#39;</span><span class="p">,</span><span class="s1">&#39;C8&#39;</span><span class="p">,</span><span class="s1">&#39;C9&#39;</span><span class="p">,</span><span class="s1">&#39;C10&#39;</span><span class="p">}</span> <span class="c1"># TC1</span>

        <span class="c1"># Select atoms that belong to the specified residue</span>
        <span class="n">indices</span> <span class="o">=</span> <span class="n">base_traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resid </span><span class="si">{</span><span class="n">resid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">)</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">indices</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>  <span class="c1"># Save the initial index of the residue</span>
    
        <span class="c1"># Create a subtrajectory containing only the specified residue</span>
        <span class="n">subtraj</span> <span class="o">=</span> <span class="n">base_traj</span><span class="o">.</span><span class="n">atom_slice</span><span class="p">(</span><span class="n">indices</span><span class="p">)</span>
        
        <span class="c1"># Select the atoms that belong to the nucleotide</span>
        <span class="c1">#sub_indices = subtraj.top.select(f&#39;name {&quot; &quot;.join(base_atoms)}&#39;)</span>
        <span class="n">sub_indices</span> <span class="o">=</span> <span class="p">[</span><span class="n">atom</span><span class="o">.</span><span class="n">index</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">subtraj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atoms</span> <span class="k">if</span> <span class="s1">&#39;</span><span class="se">\&#39;</span><span class="s1">&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span> <span class="ow">and</span> <span class="s1">&#39;P&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>
        <span class="c1"># Return the indices of the atoms that belong to the nucleotide</span>
        <span class="k">return</span> <span class="n">sub_indices</span> <span class="o">+</span> <span class="n">offset</span></div>



<div class="viewcode-block" id="Mutate.make_complementary_mutations">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Mutate.make_complementary_mutations">[docs]</a>
    <span class="k">def</span> <span class="nf">make_complementary_mutations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">mutations</span><span class="p">,</span> <span class="n">base_pair_map</span><span class="p">):</span>
        
        <span class="c1"># Get the basepair dictionary of the trajectory</span>
        <span class="n">basepair_dict</span> <span class="o">=</span> <span class="n">get_base_pair_dict</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>

        <span class="c1"># Iterate over a static list of dictionary items to avoid RuntimeError</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">base</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">mutations</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
            
            <span class="c1"># Get the complementary base</span>
            <span class="n">comp_base</span> <span class="o">=</span> <span class="n">basepair_dict</span><span class="p">[</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">_residues</span><span class="p">[</span><span class="n">idx</span><span class="p">]]</span>
            <span class="n">comp_mutant</span> <span class="o">=</span> <span class="n">base_pair_map</span><span class="p">[</span><span class="n">base</span><span class="p">]</span>
        
            <span class="c1"># Update mutations with the complementary base&#39;s mutation</span>
            <span class="n">mutations</span><span class="p">[</span><span class="n">comp_base</span><span class="o">.</span><span class="n">index</span><span class="p">]</span> <span class="o">=</span> <span class="n">comp_mutant</span>
            
        <span class="k">return</span> <span class="n">mutations</span></div>

    
    <span class="k">def</span> <span class="nf">_find_bonds_to_delete</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">target_indices</span><span class="p">):</span>
        <span class="n">pre_bonds</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">_bonds</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">_atoms</span><span class="p">)[</span><span class="n">target_indices</span><span class="p">]</span>
        <span class="n">bond_indices_to_delete</span> <span class="o">=</span> <span class="p">[]</span> 
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">bond</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pre_bonds</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                    <span class="n">bond_indices_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">_</span><span class="p">)</span>
        <span class="c1">#print(&#39;bond indices to delete&#39;, set(bond_indices_to_delete))</span>
        <span class="k">return</span> <span class="nb">list</span><span class="p">(</span><span class="nb">set</span><span class="p">(</span><span class="n">bond_indices_to_delete</span><span class="p">))</span>
    
    <span class="k">def</span> <span class="nf">_find_bonds_to_keep</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">mutant_indices</span><span class="p">):</span>
        <span class="n">pre_bonds</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">bonds</span><span class="p">)</span>
        <span class="n">bonds_to_keep</span><span class="o">=</span> <span class="p">[]</span>
        <span class="n">atoms</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">_atoms</span><span class="p">)[</span><span class="n">mutant_indices</span><span class="p">]</span>
        <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">atoms</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">_</span><span class="p">,</span><span class="n">bond</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">pre_bonds</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">bond</span><span class="p">:</span>
                    <span class="n">bonds_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">bond</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">bonds_to_keep</span>


<div class="viewcode-block" id="Mutate.update_mutant_topology">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Mutate.update_mutant_topology">[docs]</a>
    <span class="k">def</span> <span class="nf">update_mutant_topology</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">target_indices</span><span class="p">,</span> <span class="n">mutant_indices</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">mutation_traj</span><span class="p">):</span>

        <span class="c1"># Store pre-deletion atom names and indices for comparison</span>
        <span class="n">pre_atoms</span> <span class="o">=</span> <span class="p">[(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">_residues</span><span class="p">[</span><span class="n">resid</span><span class="p">]</span><span class="o">.</span><span class="n">_atoms</span><span class="p">]</span>

        <span class="c1"># Delete bonds that are no longer valid after the mutation</span>
        <span class="n">bonds_to_delete</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_bonds_to_delete</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">target_indices</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">idx</span> <span class="ow">in</span> <span class="n">bonds_to_delete</span><span class="p">:</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">_bonds</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">idx</span><span class="p">)</span>

        <span class="c1"># Delete target atoms from the topology</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_delete_target_atoms</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">target_indices</span><span class="p">)</span>
   
        <span class="c1"># Store post-deletion atom names and indices for offset calculation</span>
        <span class="n">post_atoms</span> <span class="o">=</span> <span class="p">[(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">index</span><span class="p">)</span> <span class="k">for</span> <span class="n">atom</span> <span class="ow">in</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">_residues</span><span class="p">[</span><span class="n">resid</span><span class="p">]</span><span class="o">.</span><span class="n">_atoms</span><span class="p">]</span>

        <span class="c1"># Determine the insertion offset by comparing pre and post deletion atom names and indices</span>
        <span class="n">offset</span><span class="p">,</span> <span class="n">insert_id</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_find_insertion_offset</span><span class="p">(</span><span class="n">pre_atoms</span><span class="p">,</span> <span class="n">post_atoms</span><span class="p">)</span>

        <span class="c1"># Insert new atoms into the topology at calculated positions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_insert_new_atoms</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">mutant_indices</span><span class="p">,</span> <span class="n">mutation_traj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">insert_id</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>

        <span class="c1"># Update the residue name to reflect the mutation</span>
        <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">_residues</span><span class="p">[</span><span class="n">resid</span><span class="p">]</span><span class="o">.</span><span class="n">name</span> <span class="o">=</span> <span class="sa">f</span><span class="s1">&#39;D</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">&#39;</span>

        <span class="k">return</span> <span class="n">traj</span></div>


    <span class="k">def</span> <span class="nf">_delete_target_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">target_indices</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Delete target atoms from the topology by sorting indices in reverse order</span>
<span class="sd">        to maintain index integrity after each deletion.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1">#print(&#39;og&#39;,traj.top.residue(self.current_resid)._atoms)</span>
        <span class="c1">#print(&#39;og&#39;,[at.index for at in traj.top.residue(self.current_resid)._atoms])</span>

        <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">target_indices</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">delete_atom_by_index</span><span class="p">(</span><span class="n">index</span><span class="p">)</span>
            <span class="c1">#print(&#39;del&#39;,index,traj.top.residue(self.current_resid)._atoms)</span>
            <span class="c1">#print(&#39;del&#39;,index,[at.index for at in traj.top.residue(self.current_resid)._atoms])</span>

    <span class="k">def</span> <span class="nf">_find_insertion_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">pre_atoms</span><span class="p">,</span> <span class="n">post_atoms</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Determine the correct offset for new atom insertion by comparing</span>
<span class="sd">        pre- and post-deletion atom names and indices.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Default to the last atom&#39;s index in the residue as the insertion point</span>
        <span class="n">offset</span> <span class="o">=</span> <span class="n">post_atoms</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">insert_id</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">post_atoms</span><span class="p">)</span> <span class="o">-</span> <span class="mi">1</span>

        <span class="c1"># Check for the actual offset where the first discrepancy in atom names occurs</span>
        <span class="c1"># loop over name,index pairs in pre_atoms and post_atoms</span>
        <span class="k">for</span> <span class="n">pre</span><span class="p">,</span> <span class="n">post</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">pre_atoms</span><span class="p">,</span> <span class="n">post_atoms</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">pre</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">!=</span> <span class="n">post</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                <span class="n">offset</span> <span class="o">=</span> <span class="n">pre</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">insert_id</span> <span class="o">=</span> <span class="n">post_atoms</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="n">post</span><span class="p">)</span>
                <span class="k">break</span>

        <span class="k">return</span> <span class="n">offset</span><span class="p">,</span> <span class="n">insert_id</span>
    
    <span class="k">def</span> <span class="nf">_insert_new_atoms</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">mutant_indices</span><span class="p">,</span> <span class="n">mutation_traj</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">insert_id</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">        Insert new atoms into the topology, accounting for edge cases when the insertion point</span>
<span class="sd">        is at the end of the topology.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1">#print(&#39;empty&#39;,traj.top.residue(resid)._atoms)</span>
        <span class="c1">#print(&#39;empty&#39;,[at.index for at in traj.top.residue(resid)._atoms])</span>
        <span class="k">for</span> <span class="n">idx</span><span class="p">,</span> <span class="n">mutant_index</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">mutant_indices</span><span class="p">):</span>
            <span class="n">atom</span> <span class="o">=</span> <span class="n">mutation_traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">atom</span><span class="p">(</span><span class="n">mutant_index</span><span class="p">)</span>

            <span class="c1">#print(&#39;target&#39;,offset+idx,atom)</span>
            <span class="c1"># Edge case: If the offset is the last atom in the topology, insert new atoms at the end</span>
            <span class="k">if</span> <span class="n">offset</span> <span class="o">+</span> <span class="n">idx</span> <span class="o">&gt;=</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Edgecase: inserting at or beyond the last atom in the topology&#39;</span><span class="p">,</span> <span class="n">offset</span><span class="p">,</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">n_atoms</span><span class="p">)</span>
                <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">insert_atom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">_residues</span><span class="p">[</span><span class="n">resid</span><span class="p">],</span>
                                    <span class="n">index</span><span class="o">=</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">n_atoms</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rindex</span><span class="o">=</span><span class="n">insert_id</span> <span class="o">+</span> <span class="n">idx</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># Regular case: insert new atoms at the calculated offset</span>
                <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">insert_atom</span><span class="p">(</span><span class="n">atom</span><span class="o">.</span><span class="n">name</span><span class="p">,</span> <span class="n">atom</span><span class="o">.</span><span class="n">element</span><span class="p">,</span> <span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">_residues</span><span class="p">[</span><span class="n">resid</span><span class="p">],</span>
                                    <span class="n">index</span><span class="o">=</span><span class="n">offset</span> <span class="o">+</span> <span class="n">idx</span><span class="p">,</span> <span class="n">rindex</span><span class="o">=</span><span class="n">insert_id</span> <span class="o">+</span> <span class="n">idx</span><span class="p">)</span>

            <span class="c1">#print(&#39;ins&#39;,idx+offset, traj.top.residue(resid)._atoms)</span>
            <span class="c1">#print(&#39;ins&#39;,idx+offset,[at.index for at in traj.top.residue(resid)._atoms])</span>


<div class="viewcode-block" id="Mutate.get_base_transformation">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Mutate.get_base_transformation">[docs]</a>
    <span class="k">def</span> <span class="nf">get_base_transformation</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mutant_reference</span><span class="p">,</span><span class="n">target_reference</span><span class="p">):</span>

        <span class="c1"># Collect the reference information of the mutation</span>
        <span class="n">mutation_origin</span> <span class="o">=</span> <span class="n">mutant_reference</span><span class="o">.</span><span class="n">b_R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">D</span> <span class="o">=</span> <span class="n">mutant_reference</span><span class="o">.</span><span class="n">b_D</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">L</span> <span class="o">=</span> <span class="n">mutant_reference</span><span class="o">.</span><span class="n">b_L</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">N</span> <span class="o">=</span> <span class="n">mutant_reference</span><span class="o">.</span><span class="n">b_N</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">mutation_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">D</span><span class="p">,</span><span class="n">L</span><span class="p">,</span><span class="n">N</span><span class="p">])</span>

        <span class="c1"># Collect the reference information of the target to mutate</span>
        <span class="n">target_ref</span> <span class="o">=</span> <span class="n">ReferenceBase</span><span class="p">(</span><span class="n">target_reference</span><span class="p">)</span>
        <span class="n">target_origin</span> <span class="o">=</span> <span class="n">target_ref</span><span class="o">.</span><span class="n">b_R</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">target_basis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">target_ref</span><span class="o">.</span><span class="n">b_D</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_ref</span><span class="o">.</span><span class="n">b_L</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">target_ref</span><span class="o">.</span><span class="n">b_N</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span>

        <span class="c1"># Calculate the transformation </span>
        <span class="n">rot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">target_basis</span><span class="p">,</span><span class="n">mutation_basis</span><span class="p">)</span>
        <span class="n">trans</span> <span class="o">=</span> <span class="n">target_origin</span> <span class="o">-</span> <span class="n">mutation_origin</span>
        <span class="k">return</span> <span class="n">rot</span><span class="p">,</span> <span class="n">trans</span></div>



<div class="viewcode-block" id="Mutate.apply_mutations">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Mutate.apply_mutations">[docs]</a>
    <span class="k">def</span> <span class="nf">apply_mutations</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">traj</span><span class="p">,</span> <span class="n">mutations</span><span class="p">,</span> <span class="n">base_pair_map</span><span class="p">):</span>

        <span class="c1"># Make a copy of the original trajectory</span>
        <span class="n">traj</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="n">traj</span><span class="p">)</span>
        
        <span class="c1"># This comes now directly from sequence generator.py, either move this to somewhere else such that it is accessible everywhere</span>
        <span class="c1">#reference_bases = {base: md.load_pdb(f&#39;/Users/thor/surfdrive/Projects/pymdna/pymdna/atomic/NDB96_{base}.pdb&#39;) for base in base_pair_map.keys()}</span>
        <span class="c1">#reference_bases = {base: md.load_pdb(get_data_file_path(f&#39;./atomic/NDB96_{base}.pdb&#39;)) for base in base_pair_map.keys()}</span>
        <span class="n">reference_bases</span> <span class="o">=</span> <span class="p">{</span><span class="n">base</span><span class="p">:</span> <span class="n">md</span><span class="o">.</span><span class="n">load_hdf5</span><span class="p">(</span><span class="n">get_data_file_path</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;./atomic/bases/BDNA_</span><span class="si">{</span><span class="n">base</span><span class="si">}</span><span class="s1">.h5&#39;</span><span class="p">))</span> <span class="k">for</span> <span class="n">base</span> <span class="ow">in</span> <span class="n">base_pair_map</span><span class="o">.</span><span class="n">keys</span><span class="p">()}</span>
        <span class="n">reference_frames</span> <span class="o">=</span> <span class="p">{</span><span class="n">letter</span><span class="p">:</span> <span class="n">ReferenceBase</span><span class="p">(</span><span class="n">t</span><span class="p">)</span> <span class="k">for</span> <span class="n">letter</span><span class="p">,</span><span class="n">t</span> <span class="ow">in</span> <span class="n">reference_bases</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="c1"># for letter, base in reference_bases.items():</span>
    
        <span class="c1">#     print(letter,base, base.top, base.top._residues)</span>
        <span class="c1">#     ref = ReferenceBase(base)</span>
        <span class="c1">#     # vectors = get_base_vectors(base)</span>
        <span class="c1">#     # print(np.round(vectors),2)</span>

        <span class="c1"># For each residue that needs to be mutated</span>
        <span class="k">for</span> <span class="n">resid</span><span class="p">,</span><span class="n">base</span> <span class="ow">in</span> <span class="n">mutations</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
            <span class="c1"># print(traj.top, traj.top._residues)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">current_resid</span> <span class="o">=</span> <span class="n">resid</span>
            <span class="c1"># Get the mutant trajectory object</span>
            <span class="n">mutation_traj</span> <span class="o">=</span> <span class="n">reference_bases</span><span class="p">[</span><span class="n">base</span><span class="p">]</span> 

            <span class="c1"># Get the indices of the atoms that need to be transformed</span>
            <span class="n">mutant_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_indices</span><span class="p">(</span><span class="n">mutation_traj</span><span class="p">,</span> <span class="n">resid</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">target_indices</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_indices</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">resid</span><span class="o">=</span><span class="n">resid</span><span class="p">)</span>

            <span class="c1">#sub_m = mutation_traj.atom_slice(mutant_indices)</span>
            <span class="c1">#sub_w = traj.atom_slice(target_indices)</span>

            <span class="c1">#print(&#39;m&#39;,sub_m.top._residues[0],sub_m.top._atoms)</span>
            <span class="c1">#print(&#39;w&#39;,sub_w.top._residues[0],sub_w.top._atoms)</span>
            
            <span class="c1"># Get the transformation for the local reference frames from the mutant to the target</span>
            <span class="n">mutant_reference</span> <span class="o">=</span> <span class="n">reference_frames</span><span class="p">[</span><span class="n">base</span><span class="p">]</span>
            <span class="n">target_reference</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">atom_slice</span><span class="p">(</span><span class="n">traj</span><span class="o">.</span><span class="n">top</span><span class="o">.</span><span class="n">select</span><span class="p">(</span><span class="sa">f</span><span class="s1">&#39;resid </span><span class="si">{</span><span class="n">resid</span><span class="si">}</span><span class="s1">&#39;</span><span class="p">))</span>
            <span class="c1"># print(resid, target_reference.top,  target_reference.top._residues)</span>
            <span class="n">rot</span><span class="p">,</span> <span class="n">trans</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_base_transformation</span><span class="p">(</span><span class="n">mutant_reference</span><span class="p">,</span> <span class="n">target_reference</span><span class="p">)</span>
           
            <span class="c1"># Transform the mutant atoms to the local reference frame of the target</span>
            <span class="n">mutant_xyz</span> <span class="o">=</span> <span class="n">mutation_traj</span><span class="o">.</span><span class="n">xyz</span><span class="p">[:,</span><span class="n">mutant_indices</span><span class="p">,:]</span>
            <span class="n">new_xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mutant_xyz</span><span class="p">,</span> <span class="n">rot</span><span class="o">.</span><span class="n">T</span><span class="p">)</span> <span class="o">+</span> <span class="n">trans</span>    

            <span class="c1"># Get the original xyz coordinates</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">traj</span><span class="o">.</span><span class="n">xyz</span> 
            <span class="c1">#print(&#39;target_indices:&#39;,target_indices)</span>
            <span class="c1"># Split the xyz in 2 pieces, one before the indices that need to be replaced, and the indices after the indices that need to be replaced</span>
            <span class="n">xyz1</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[:,:</span><span class="n">target_indices</span><span class="p">[</span><span class="mi">0</span><span class="p">],:]</span> 
            <span class="n">xyz2</span> <span class="o">=</span> <span class="n">xyz</span><span class="p">[:,</span><span class="n">target_indices</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">:,]</span>

            <span class="c1"># Update the topology</span>
            <span class="n">traj</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">update_mutant_topology</span><span class="p">(</span><span class="n">traj</span><span class="p">,</span> <span class="n">target_indices</span><span class="p">,</span> <span class="n">mutant_indices</span><span class="p">,</span> <span class="n">base</span><span class="p">,</span> <span class="n">resid</span><span class="p">,</span> <span class="n">mutation_traj</span><span class="p">)</span>

            <span class="c1"># Concatenate the new xyz with the original xyz</span>
            <span class="n">xyz</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">xyz1</span><span class="p">,</span> <span class="n">new_xyz</span><span class="p">,</span> <span class="n">xyz2</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">traj</span><span class="o">.</span><span class="n">xyz</span> <span class="o">=</span> <span class="n">xyz</span>

        <span class="c1"># Return the mutated trajectory</span>
        <span class="k">return</span> <span class="n">traj</span></div>


<div class="viewcode-block" id="Mutate.get_traj">
<a class="viewcode-back" href="../../pymdna.html#pymdna.modifications.Mutate.get_traj">[docs]</a>
    <span class="k">def</span> <span class="nf">get_traj</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">mutant_traj</span></div>
</div>


<span class="c1"># traj = md.load(&#39;/Users/thor/surfdrive/Data/h-ns/BacterialChromatin/FI/0_k/2_ApT/dry_0.pdb&#39;)</span>
<span class="c1"># traj.remove_solvent(inplace=True)</span>
<span class="c1"># traj = traj.atom_slice(traj.topology.select(&#39;not protein&#39;))[0]</span>
<span class="c1"># # traj = traj.atom_slice(traj.topology.select(&#39;resid 0 23&#39;))# and not element symbol H&#39;))</span>

<span class="c1"># # Create a DNA object</span>
<span class="c1"># dna = mdna.NucleicFrames(traj)</span>

<span class="c1"># # Define the base pair map and the complementary mutant map</span>
<span class="c1"># base_pair_map = {&#39;A&#39;: &#39;T&#39;, &#39;T&#39;: &#39;A&#39;, &#39;C&#39;: &#39;G&#39;, &#39;G&#39;: &#39;C&#39;}#,&#39;P&#39;:&#39;T&#39;,&#39;M&#39;:&#39;C&#39;,&#39;H&#39;:&#39;T&#39;}</span>


<span class="c1"># # Get base frames from current DNA sequence</span>
<span class="c1"># base_frames = dna.frames</span>

<span class="c1"># # # Define the mutation to be performed</span>
<span class="c1"># complementary = True</span>
<span class="c1"># mutations = {0: &#39;A&#39;, 6: &#39;T&#39;}</span>

<span class="c1"># if complementary:</span>
<span class="c1">#     # Update dict with the complementary mutations</span>
<span class="c1">#     mutations = make_complementary_mutations(traj, mutations, base_pair_map)</span>

<span class="c1"># print(mutations)</span>
<span class="c1"># sequence = mdna.utils.get_sequence_letters(traj)</span>
<span class="c1"># sequence_pairs = mdna.utils.get_base_pair_letters(traj)</span>
<span class="c1"># new_sequences = [mutations.get(idx, seq) for idx, seq in enumerate(sequence)]</span>

<span class="c1"># print(&#39;WT&#39;,sequence)</span>
<span class="c1"># # print(new_sequences)</span>

<span class="c1"># # Apply the mutations</span>
<span class="c1"># mutant_traj = apply_mutations(traj, mutations, base_pair_map)</span>
    
<span class="c1"># new_sequence = mdna.utils.get_sequence_letters(mutant_traj)</span>
<span class="c1"># print(&#39;M &#39;,new_sequence)</span>
<span class="c1"># view = nv.show_mdtraj(mutant_traj)</span>
<span class="c1"># view.clear_representations()</span>
<span class="c1"># view.add_representation(&#39;ball+stick&#39;, selection=&#39;all&#39;)</span>
<span class="c1"># view</span>
</pre></div>

          </div>
          
        </div>
      </div>
      <div class="sphinxsidebar" role="navigation" aria-label="main navigation">
        <div class="sphinxsidebarwrapper">
<h1 class="logo"><a href="../../index.html">mdna</a></h1>








<h3>Navigation</h3>
<p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">pymdna</a></li>
</ul>

<div class="relations">
<h3>Related Topics</h3>
<ul>
  <li><a href="../../index.html">Documentation overview</a><ul>
  <li><a href="../index.html">Module code</a><ul>
  <li><a href="../pymdna.html">pymdna</a><ul>
  </ul></li>
  </ul></li>
  </ul></li>
</ul>
</div>
<search id="searchbox" style="display: none" role="search">
  <h3 id="searchlabel">Quick search</h3>
    <div class="searchformwrapper">
    <form class="search" action="../../search.html" method="get">
      <input type="text" name="q" aria-labelledby="searchlabel" autocomplete="off" autocorrect="off" autocapitalize="off" spellcheck="false"/>
      <input type="submit" value="Go" />
    </form>
    </div>
</search>
<script>document.getElementById('searchbox').style.display = "block"</script>








        </div>
      </div>
      <div class="clearer"></div>
    </div>
    <div class="footer">
      &#169;2024, Thor van Heesch.
      
      |
      Powered by <a href="https://www.sphinx-doc.org/">Sphinx 7.3.7</a>
      &amp; <a href="https://alabaster.readthedocs.io">Alabaster 0.7.16</a>
      
    </div>

    

    
  </body>
</html>